<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fiber Example</title>
    <link rel="stylesheet" href="../shared/css/base.css" />
  </head>
  <body>
    <h1>Fiber Example</h1>
    <div id="container">
      <p>
        To install React, follow the instructions on
        <a href="https://github.com/facebook/react/">GitHub</a>.
      </p>
      <p>
        If you can see this, React is <strong>not</strong> working right.
        If you checked out the source from GitHub make sure to run <code>grunt</code>.
      </p>
    </div>
    <script src="../../build/react.js"></script>
    <script src="../../build/react-dom-fiber.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.min.js"></script>
    <script type="text/babel">
      var dotStyle = {
        position: 'absolute',
        background: '#61dafb',
        font: 'normal 15px sans-serif',
        textAlign: 'center',
        cursor: 'pointer',
      };

      var containerStyle = {
        position: 'absolute',
        transformOrigin: '0 0',
        left: '50%',
        top: '50%',
        width: '10px',
        height: '10px',
        background: '#eee',
      };

      var targetSize = 25;

      function updateSelection(idx) {
        // TODO
      }

      function Dot(props) {
        var s = props.size;
        var idx = props.idx;
        var style = {
          ...dotStyle,
          width: s + 'px',
          height: s + 'px',
          left: (props.x) + 'px',
          top: (props.y) + 'px',
          borderRadius: (s / 2) + 'px',
          lineHeight: (s) + 'px',
          // background: idx === hoveredIdx ? '#ff0' : dotStyle.background
        };
        return (
          <div style={style} onMouseEnter={() => updateSelection(idx)}>
            {props.text}
          </div>
        );
      }

      function SierpinskiTriangle({ x, y, s, idx, depth, hover, children }) {
        if (s <= targetSize) {
          return (
            <Dot
              x={x - (targetSize / 2)}
              y={y - (targetSize / 2)}
              size={targetSize}
              text={children}
              idx={idx}
              hover={hover}
            />
          );
          return r;
        }
        var newSize = s / 2;
        // Artificially long execution time.
        s = 0;
        while (s < 100000) {
          s++;
        }
        if (s > newSize) {
          s = newSize;
        }

        return [
          <SierpinskiTriangle x={x} y={y - (s / 2)} s={s}>
            {children}
          </SierpinskiTriangle>,
          <SierpinskiTriangle x={x - s} y={y + (s / 2)} s={s}>
            {children}
          </SierpinskiTriangle>,
          <SierpinskiTriangle x={x + s} y={y + (s / 2)} s={s}>
            {children}
          </SierpinskiTriangle>,
        ];
      }
      SierpinskiTriangle.shouldComponentUpdate = function(oldProps, newProps) {
        var o = oldProps;
        var n = newProps;
        // console.log(o, n);
        return !(
          o.x === n.x &&
          o.y === n.y &&
          o.s === n.s &&
          // o.idx === n.idx &&
          // o.depth === n.depth &&
          // o.hover === n.hover &&
          o.children === n.children
        );
      };

      function ExampleApplication(props) {
        var seconds = (props.elapsed / 1000) % 10;
        var scale = 1 + (seconds > 5 ? 10 - seconds : seconds) / 10;
        var transform = 'scale(' + (scale / 2.1) + ') translateZ(0.1px)';
        var lowPriChildren = true; // change this to false to see the effect

        return (
          <div style={{ ...containerStyle, transform }}>
            <div hidden={lowPriChildren}>
              <SierpinskiTriangle x={0} y={0} s={1000}>
                {'' + Math.floor(seconds)}
              </SierpinskiTriangle>
            </div>
          </div>
        );
      }

      var start = new Date().getTime();
      var f = 0;
      function update() {
        // ReactDOMFiber.dumpTree();
        ReactDOMFiber.render(
          <ExampleApplication elapsed={new Date().getTime() - start} />,
          document.getElementById('container')
        );
        //if (f++ < 5) {
          requestAnimationFrame(update);
        // }
      }
      requestAnimationFrame(update);
    </script>
  </body>
</html>
